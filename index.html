<!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Glioma Trial Enrollment Predictor</title>
     <title>GPREDICT: Prediction of Glioma Patients' Enrollment In Therapeutic Clinical Trials</title>
     <style>
         /* General Styling */
         body {
             font-family: Arial, sans-serif;
             max-width: 800px;
             margin: auto;
             padding: 20px;
             text-align: center;
             background-color: #f5f5f5;
         }
 
         .container {
             background: white;
             padding: 20px;
             border-radius: 10px;
             box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
             text-align: left;
         }
 
         /* Title Styling */
         .title {
             font-size: 2em;
             font-weight: bold;
             color: #052049;
             margin-bottom: 10px;
         }
 
         /* Description Styling */
         .description {
             font-size: 1em;
             color: #333;
             margin-bottom: 20px;
             text-align: center;
             max-width: 90%;
             margin-left: auto;
             margin-right: auto;
             line-height: 1.5;
         }
 
         /* Section Titles - UCSF Dark Blue */
         .section-title {
             font-size: 1.2em;
             font-weight: bold;
             color: #052049; /* UCSF Dark Blue */
             margin-top: 20px;
             padding-bottom: 5px;
             border-bottom: 2px solid #052049; /* Ensure border color matches */
             text-align: left;
         }
 
         /* Form Inputs */
         .form-group {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin: 10px 0;
         }
 
         .form-group label {
             width: 50%;
         }
 
         input, select {
             padding: 8px;
             width: 50%;
             border: 1px solid #ccc;
             border-radius: 5px;
             background: #fafafa;
             box-sizing: border-box; /* Ensures same width */
         }

      /* 🔴 Highlight Age Input Field if Invalid */
input.error {
    border: 2px solid red;
    background-color: #ffe6e6;
}

/* 🔴 Error Message for Missing Age */
#error-message {
    color: red;
    font-size: 0.9em;
    margin-top: 10px;
    display: none; /* Initially hidden */
}
 
         /* Calculate Probability Button - UCSF Light Blue */
         button {
             padding: 12px;
             width: 100%;
             background-color: #0076cf; /* UCSF Light Blue */
             color: white;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             margin-top: 20px;
             font-size: 1em;
             font-weight: bold;
         }
 
         button:hover {
             background-color: #0056a4; /* Slightly Darker UCSF Blue */
         }
 
         /* Enrollment Probability Box */
         .result-box {
             display: none;
          width: 90%; /* Set width to 90% of its container */
    max-width: 90%; /* Ensures it does not exceed this width */
    margin: 20px auto; /* Center horizontally */
             padding: 15px;
             background: #f0f0f0;
             border-radius: 10px;
             text-align: center;
             font-size: 1.2em;
             font-weight: bold;
             border: 2px solid #052049;
         }
 
         #resultText {
             font-size: 1.2em; /* Same as heading */
         }
 
         /* Toggle Buttons - Stack vertically */
.toggle-buttons {
    display: flex;
    flex-direction: column; /* Stack buttons vertically */
    align-items: center; /* Center the buttons */
    width: 100%;
    margin-top: 20px;
}

/* Ensure all toggle buttons match the width of "Calculate Probability" button */
.toggle-button,
.toggle-button-teal {
    width: 100%; /* Full width */
    max-width: 100%; /* Matches result box */
    padding: 12px;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    font-weight: bold;
    margin: 10px auto; /* Space between buttons */
    display: block;
}

/* General Recommendations Button */
.toggle-button-teal {
    background-color: #007272;
}

.toggle-button-teal:hover {
    background-color: #005555;
}

/* Patient-Specific Buttons */
.toggle-button-blue {
    background-color: #052049;
}

.toggle-button-blue:hover {
    background-color: #02152b;
}

.toggle-button-orange {
    background-color: #C04C00;
}

.toggle-button-orange:hover {
    background-color: #8a3700;
}
 
         /* Ensure all toggle content sections (tables) match the result box width */
.toggle-content {
    width: 95%; /* Set width to 90% of its container */
    max-width: 95%; /* Ensures it does not exceed this width */
    margin: 20px auto; /* Center horizontally */
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    border: 2px solid #dcdcdc;
    box-sizing: border-box;
    display: none; /* Hide by default */
}
         }
         /* Headings */
         h3 {
             color: #333;
             margin-top: 15px;
         }
 
         /* Impact Titles */
         .impact-title {
             font-size: 1.2em;
             font-weight: bold;
             margin-bottom: 10px;
         }
 
         /* Impact Table */
         .impact-table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 10px;
         }
 
         .impact-table th, .impact-table td {
             padding: 10px;
             text-align: left;
             border: 1px solid #ddd;
         }
 
         .impact-table th {
             background-color: #f5f5f5;
             font-weight: bold;
         }
 
         /* Increasing Factors Column - UCSF Blue */
         .increase {
             color: #052049;
             font-weight: bold;
         }
 
         /* Decreasing Factors Column - UCSF Orange */
         .decrease {
             color: #C04C00;
             font-weight: bold;
         }
 
         .recommendation-table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 10px;
         }
 
         .recommendation-table th, .recommendation-table td {
             padding: 10px;
             text-align: left;
             border: 1px solid #ddd;
         }
 
         .recommendation-table th {
             background-color: #f5f5f5;
             font-weight: bold;
         }
 
         /* Patient Characteristics Column - UCSF Blue */
         .characteristics {
             color: #052049;
             font-weight: bold;
         }
 
         /* Recommendations Column - UCSF Orange */
         .recommendations {
             color: #C04C00;
         }
 .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the text */
            left: 50%;
            margin-left: -110px; /* Center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

      /* Citations Button - UCSF Lighter Blue */
.toggle-button-ucsf-light-blue {
    background-color: #66A3D2; /* Softer Lighter UCSF Blue */
}

.toggle-button-ucsf-light-blue:hover {
    background-color: #4D90C5; /* Slightly Darker for Hover Effect */
}

/* Ensure citations list matches other content width */
#citationsSection {
    width: 95%; /* Same width as impact tables */
    max-width: 95%;
    text-align: left; /* Align text for readability */
}

#citationsList {
    padding-left: 20px; /* Indent numbering */
}

#citationsList li {
    margin-bottom: 10px; /* Space between citations */
    font-size: 0.95em;
    line-height: 1.5;
}
 
     </style>
 </head>
 
 <body>
     
     <h1 class="title">GPREDICT: Prediction of Glioma Patients' Enrollment In Therapeutic Clinical Trials</h1>
     <p class="description">GPREDICT allows clinicians and researchers to estimate individual adult glioma patients' probability of enrolling in a therapeutic clinical trial, identify which patient characteristics most influence enrollment probability for a given patient, and generate general and patient-specific recommendations for increasing the probability of accrual.</p>
    
     <div class="container">
         <form id="predictionForm">
             <!-- General Recommendations Button Now Above the Form -->
            
            <!-- DEMOGRAPHIC VARIABLES -->
            <div class="section-title">Demographic Variables</div>
            <div class="form-group">
                <label for="AgeDiagnosis">Age at Initial Diagnosis (years):</label>
                <input type="number" id="AgeDiagnosis" required>
            </div>

            <div class="form-group">
                <label for="Sex">Sex:</label>
                <select id="Sex" required>
                    <option value="1">Male</option>
                    <option value="2">Female</option>
                </select>
            </div>

            <div class="form-group">
                <label for="Race">Race:</label>
                <select id="Race" required>
                    <option value="White">White</option>
                    <option value="Black">Black/African American</option>
                    <option value="NativeAmerican">American Indian/Alaska Native</option>
                    <option value="Asian">Asian</option>
                    <option value="Pacific">Native Hawaiian or Pacific Islander</option>
                    <option value="Other">Other</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="Ethnicity">Ethnicity:</label>
                <select id="Ethnicity" required>
                    <option value="1">Hispanic/Latino</option>
                    <option value="2">Non-Hispanic/Latino</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="PreferredLanguage">Preferred Language: *</label>
                <select id="PreferredLanguage" required>
                    <option value="1">English</option>
                    <option value="2">Non-English Language</option>
                </select>
            </div>

            <!-- SOCIOECONOMIC VARIABLES -->
            <div class="section-title">Socioeconomic Variables</div>
            <div class="form-group">
                <label for="Insurance">Insurance Status at Diagnosis:</label>
                <select id="Insurance" required>
                    <option value="1">Private</option>
                    <option value="2">Medi-cal/Medicaid</option>
                    <option value="3">Medicare</option>
                    <option value="4">Unknown</option>
                    <option value="5">Self-pay</option>
                </select>
            </div>

            <div class="form-group">
                <label for="Employment">Employment Status:</label>
                <select id="Employment" required>
                    <option value="1">Employed</option>
                    <option value="2">Unemployed</option>
                    <option value="3">Retired</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>

            <div class="form-group">
    <label for="IncomeZip" style="color: #052049;">
        Neighborhood Median Household Income by Patient Zip Code ($) 
        <a href="https://mmehari2025.github.io/incomezipdatasearch/" target="_blank" 
           style="color: #052049; text-decoration: none;">
            [income data linked <span style="text-decoration: underline; color: #3399FF;">here</span>]</a>: *
    </label>
    <input type="number" id="IncomeZip" required>
</div>

            <div class="form-group">
                <label for="DistanceHospital">Driving Distance from Patient's Home to Hospital (miles): *</label>
                <input type="number" id="DistanceHospital" required>
            </div>

            <!-- ONCOLOGIC VARIABLES -->
            <div class="section-title">Oncologic Variables</div>
            <div class="form-group">
                <label for="WHOGrade">WHO Grade:</label>
                <select id="WHOGrade" required>
                    <option value="2-3">Grade 2-3</option>
                    <option value="4">Grade 4</option>
                </select>
            </div>

            <div class="form-group">
                <label for="TumorLobe">Tumor Lobe:</label>
                <select id="TumorLobe" required>
                    <option value="Frontal">Frontal</option>
                    <option value="Parietal">Parietal</option>
                    <option value="Temporal">Temporal</option>
                    <option value="Brainstem">Brainstem, Insular, Basal Ganglia, or Thalamus</option>
                    <option value="Multifocal">Multifocal</option>
                    <option value="Occipital">Occipital</option>
                    <option value="Cerebellum">Cerebellum</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="Seizure">Seizure at Diagnosis:</label>
                <select id="Seizure" required>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="NA">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="KPSPostOp">KPS after Surgery:</label>
                <select id="KPSPostOp" required>
                    <option value="100">100</option>
                    <option value="90">90</option>
                    <option value="80">80</option>
                    <option value="<80">Less than 80</option>
                    <option value="NA">Unknown</option>
                </select>
            </div>

            <div class="form-group">
                <label for="Chemotherapy">History of Chemotherapy Use?</label>
                <select id="Chemotherapy" required>
                    <option value="1">Yes</option>
                    <option value="2">No</option>
                    <option value="Unknown">Unknown</option>
                </select>
            </div>
          <!-- Add this note at the bottom of the page -->
<p>* These variables are not incorporated as predictors into the boosted neural network for probability calculations but may help guide recommendations to increase accrual.</p>
    </div>

            <button type="button" onclick="calculateProbability()">Calculate Probability</button>
<p id="error-message">Please input the patient's age at diagnosis in the highlighted field to calculate the estimated enrollment probability.</p>
        </form>

        <h4 id="shapImpact"></h4>

        <!-- Display Probability -->
        <div id="resultBox" class="result-box">
            <h3>Estimated Enrollment Probability:</h3>
            <p id="resultText"></p> <!-- ✅ Fixed: Probability is displayed inside the gray box -->
        </div>
        
        <!-- General Recommendations -->
<div class="centered-container">
    <button class="toggle-button toggle-button-teal" onclick="toggleSection('generalRecommendations')">
        General Recommendations for Trial Screening <span>▼</span>
    </button>
    <div id="generalRecommendations" class="toggle-content">
        <div class="impact-title">General Recommendations for Trial Screening</div>
        <table class="recommendation-table">
            <thead>
                <tr>
                    <th style="color: #052049;">Screening Discussion Patterns</th>
                    <th style="color: #C04C00;">Recommendations</th>
                </tr>
            </thead>
            <tbody id="generalRecommendationTableBody"></tbody>
        </table>
    </div>
</div>

       <!-- Toggle Buttons (Now Stacked Vertically) -->
<div class="toggle-buttons">
    <button class="toggle-button toggle-button-blue" onclick="toggleSection('impactSection')">
        Patient-Specific Characteristics Influencing Enrollment <span>▼</span>
    </button>

    <!-- Impact Section (Directly Below Button) -->
    <div id="impactSection" class="toggle-content">
        <div class="impact-title">Patient-Specific Characteristics That Most Influence Enrollment Probability</div>
        <table class="impact-table">
            <thead>
                <tr>
                    <th style="background-color: #f5f5f5; color: #052049; text-align: left;">
                        Factors Increasing Enrollment Probability
                    </th>
                </tr>
            </thead>
            <tbody id="positiveImpactTableBody"></tbody>
            <thead>
                <tr>
                    <th style="background-color: #f5f5f5; color: #C04C00; text-align: left;">
                        Factors Decreasing Enrollment Probability
                    </th>
                </tr>
            </thead>
            <tbody id="negativeImpactTableBody"></tbody>
        </table>
    </div>

    <button class="toggle-button toggle-button-orange" onclick="toggleSection('patientRecommendations')">
        Patient-Specific Recommendations <span>▼</span>
    </button>

    <!-- Patient-Specific Recommendations Section (Now Correctly Below Its Button) -->
    <div id="patientRecommendations" class="toggle-content">
        <div class="impact-title">Patient-Specific Recommendations</div>
        <table class="recommendation-table">
            <thead>
                <tr>
                    <th style="color: #052049;">Patient Characteristics and Context</th>
                    <th style="color: #C04C00;">Recommendations</th>
                </tr>
            </thead>
            <tbody id="patientRecommendationTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Citations Toggle Button -->
<button class="toggle-button toggle-button-ucsf-light-blue" onclick="toggleSection('citationsSection')">
    References & Citations <span>▼</span>
</button>

<!-- Citations Section -->
<div id="citationsSection" class="toggle-content">
    <div class="impact-title">References & Citations</div>
    <ol id="citationsList">
        <li>Morshed RA, Reihl SJ, Molinaro AM, Kakaizada S, Young JS, Schulte JD, Butowski N, Taylor J, Bush NA, Aghi MK, Berger MS, Chang S, Clarke J, Hervey-Jumper SL. The influence of race and socioeconomic status on therapeutic clinical trial screening and enrollment. <i>J Neurooncol</i>. 2020 May;148(1):131-139. doi: 10.1007/s11060-020-03503-x. PMID: 32350780.</li>
        <li>Oyer RA, Hurley P, Boehmer L, Bruinooge SS, Levit K, Barrett N, Benson A, Bernick LA, Byatt L, Charlot M, Crews J, DeLeon K, Fashoyin-Aje L, Garrett-Mayer E, Gralow JR, Green S, Guerra CE, Hamroun L, Hardy CM, Hempstead B, Jeames S, Mann M, Matin K, McCaskill-Stevens W, Merrill J, Nowakowski GS, Patel MI, Pressman A, Ramirez AG, Segura J, Segarra-Vasquez B, Hanley Williams J, Williams JE Jr, Winkfield KM, Yang ES, Zwicker V, Pierce LJ. Increasing Racial and Ethnic Diversity in Cancer Clinical Trials: An American Society of Clinical Oncology and Association of Community Cancer Centers Joint Research Statement. <i>J Clin Oncol</i>. 2022 Jul 1;40(19):2163-2171. doi: 10.1200/JCO.22.00754. PMID: 35588469.</li>
        <li>Unger JM, Hershman DL, Till C, Minasian LM, Osarogiagbon RU, Fleury ME, Vaidya R. "When Offered to Participate": A Systematic Review and Meta-Analysis of Patient Agreement to Participate in Cancer Clinical Trials. <i>J Natl Cancer Inst</i>. 2021 Mar 1;113(3):244-257. doi: 10.1093/jnci/djaa155. PMID: 33022716; PMCID: PMC7936064.</li>
        <li>Murthy VH, Krumholz HM, Gross CP. Participation in cancer clinical trials: race-, sex-, and age-based disparities. <i>JAMA</i>. 2004 Jun 9;291(22):2720-6. doi: 10.1001/jama.291.22.2720. PMID: 15187053.</li>
        <li>Reihl SJ, Patil N, Morshed RA, Mehari M, Aabedi A, Chukwueke UN, Porter AB, Fontil V, Cioffi G, Waite K, Kruchko C, Ostrom Q, Barnholtz-Sloan J, Hervey-Jumper SL. A population study of clinical trial accrual for women and minorities in neuro-oncology following the NIH Revitalization Act. <i>Neuro Oncol</i>. 2022 Aug 1;24(8):1341-1349. doi: 10.1093/neuonc/noac011. PMID: 34999844; PMCID: PMC9340618.</li>
     <li>Acuña-Villaorduña A, Baranda JC, Boehmer J, Fashoyin-Aje L, Gore SD. Equitable Access to Clinical Trials: How Do We Achieve It? <i>Am Soc Clin Oncol Educ Book</i>. 2023 May;43:e389838. doi: 10.1200/EDBK_389838. PMID: 37146264.</li>
        <li>Kim ES, Bruinooge SS, Roberts S, Ison G, Lin NU, Gore L, Uldrick TS, Lichtman SM, Roach N, Beaver JA, Sridhara R, Hesketh PJ, Denicoff AM, Garrett-Mayer E, Rubin E, Multani P, Prowell TM, Schenkel C, Kozak M, Allen J, Sigal E, Schilsky RL. Broadening Eligibility Criteria to Make Clinical Trials More Representative: American Society of Clinical Oncology and Friends of Cancer Research Joint Research Statement. <i>J Clin Oncol</i>. 2017 Nov 20;35(33):3737-3744. doi: 10.1200/JCO.2017.73.7916. Epub 2017 Oct 2. PMID: 28968170; PMCID: PMC5692724.</li>
     <li>Muthukumar AV, Morrell W, Bierer BE. Evaluating the frequency of English language requirements in clinical trial eligibility criteria: A systematic analysis using ClinicalTrials.gov. <i>PLoS Med</i>. 2021 Sep 14;18(9):e1003758. doi: 10.1371/journal.pmed.1003758. PMID: 34520467; PMCID: PMC8439488.</li>
        <li>Medina SP, Zhang S, Nieves E, Dornsife DL, Johnson R, Spicer D, Borno HT. Experiences of a Multiethnic Cohort of Patients Enrolled in a Financial Reimbursement Program for Cancer Clinical Trials. <i>JCO Oncol Pract</i>. 2023 May;19(5):e801-e810. doi: 10.1200/OP.22.00429. Epub 2023 Feb 17. PMID: 36800640.</li>
     <li>Borno HT, Zhang L, Siegel A, Chang E, Ryan CJ. At What Cost to Clinical Trial Enrollment? A Retrospective Study of Patient Travel Burden in Cancer Clinical Trials. <i>Oncologist</i>. 2018 Oct;23(10):1242-1249. doi: 10.1634/theoncologist.2017-0628. PMID: 29700209; PMCID: PMC6263122.</li>
     <li>Caston NE, Williams CP, Wan C, Ye S, Pywell C, Ingram SA, Azuero A, Sussell J, Patel S, Arend R, Rocque GB. Associations between geography, decision-making style, and interest in cancer clinical trial participation. <i>Cancer</i>. 2022 Nov 15;128(22):3977-3984. doi: 10.1002/cncr.34455. Epub 2022 Sep 16. PMID: 36111955.</li>
     <li>Agaronnik ND, Peters MLB, Iezzoni LI. Exclusion of people from oncology clinical trials based on functional status. <i>Clin Trials</i>. 2025 Jan 2:17407745241304114. doi: 10.1177/17407745241304114. Epub ahead of print. PMID: 39744922.</li>
     <li>Abi Jaoude J, Kouzy R, Mainwaring W, Lin TA, Miller AB, Jethanandani A, Espinoza AF, Pasalic D, Verma V, VanderWalde NA, Smith BD, Smith GL, Fuller CD, Das P, Minsky BD, Rödel C, Fokas E, Jagsi R, Thomas CR, Subbiah IM, Taniguchi CM, Ludmir EB. Performance Status Restriction in Phase III Cancer Clinical Trials. <i>J Natl Compr Canc Netw</i>. 2020 Oct 1;18(10):1322-1326. doi: 10.6004/jnccn.2020.7578. PMID: 33022640; PMCID: PMC9671537.</li>
     <li>Hutchins LF, Unger JM, Crowley JJ, Coltman CA Jr, Albain KS. Underrepresentation of patients 65 years of age or older in cancer-treatment trials. <i>N Engl J Med</i>. 1999 Dec 30;341(27):2061-7. doi: 10.1056/NEJM199912303412706. PMID: 10615079.</li>
        <li>Hurria A, Dale W, Mooney M, Rowland JH, Ballman KV, Cohen HJ, Muss HB, Schilsky RL, Ferrell B, Extermann M, Schmader KE, Mohile SG; Cancer and Aging Research Group. Designing therapeutic clinical trials for older and frail adults with cancer: U13 conference recommendations. <i>J Clin Oncol</i>. 2014 Aug 20;32(24):2587-94. doi: 10.1200/JCO.2013.55.0418. PMID: 25071116; PMCID: PMC4129504.</li>
        <li>Scher KS, Hurria A. Under-representation of older adults in cancer registration trials: known problem, little progress. <i>J Clin Oncol</i>. 2012 Jun 10;30(17):2036-8. doi: 10.1200/JCO.2012.41.6727. PMID: 22547597.</li>
    </ol>
</div>

    <script src="jmp_score.js"></script> <!-- 📌 Ensures the model is correctly linked -->
    <script src="model.js"></script>

    <script>
        function toggleSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (section.style.display === "none" || section.style.display === "") {
        section.style.display = "block"; // Show section
    } else {
        section.style.display = "none"; // Hide section
    }
}
    </script>
    
    <script>
        const variableMap = {
            "AgeDiagnosis": "Age.at.Initial.Diagnosis",
            "Employment": "Employed(Y=1, N=2, Retired=3) 2",
            "Ethnicity": "Ethnicity Hispanic/Latino (Yes=1, No=2) 2",
            "KPSPostOp": "KPS.post.op 3",
            "TumorLobe": "New Tumor Lobe (updated chart review) 2 2 2",
            "Insurance": "Reordered insurance at diagnosis 2 2",
            "Seizure": "Seizure.preop 2",
            "Sex": "Sex (M=1, F=2)",
            "Chemotherapy": "TMZ anytime 2 2",
            "Race": "Updated Race White, Black/African American, Hispanic/Latino, Asian/Pacific Islander, American Indian/Alaska Native 3 2",
            "WHOGrade": "WHO Grade 2 2"
        };
        
        const shapValues = {
            "Race": { "Asian": -0.0433, "Black": -0.101, "White": 0.0101, "Pacific": -0.0736, "Other": -0.0709, "NativeAmerican": -0.0628 },
            "Ethnicity": { "1": -0.0542, "2": 0.00420 },
            "Sex": { "1": -0.00185, "2": 0.00269 },
            "Insurance": { "1": 0.00875, "2": -0.0313, "3": -0.0620, "5": 0.000860 },
            "Chemotherapy": { "1": 0.0582, "2": -0.1404 },
            "WHOGrade": { "2-3": -0.0544, "4": 0.0326 },
            "AgeDiagnosis": (ages) => {
                if (ages < 20) return 0.0868;
                if (ages < 30) return 0.0299;
                if (ages < 40) return 0.00843;
                if (ages < 50) return 0.00225;
                if (ages < 60) return 0.00206;
                if (ages < 70) return -0.00581;
                if (ages < 80) return -0.0310;
                return -0.0774;
            },
            "KPSPostOp": { "100": 0.1543, "90": 0.0700, "80": 0.0500, "<80": -0.129 },
            "TumorLobe": { 
                "Frontal": -0.0228, 
                "Temporal": -0.0153, 
                "Parietal": 0.0240, 
                "Brainstem": 0.0504, 
                "Cerebellum": -0.0757, 
                "Multifocal": 0.1065, 
                "Occipital": 0.1495 
            },
            "Seizure": { "Yes": 0.0344, "No": -0.0573 },
            "Employment": { "1": 0.0229, "2": -0.0288, "3": 0.0192 }
        };
    
        function calculateProbability() {
        let ageInput = document.getElementById("AgeDiagnosis");
    let ageValue = ageInput.value.trim();
    let errorMessage = document.getElementById("error-message");

    // 🔴 If Age is empty or invalid, show error
    if (ageValue === "" || isNaN(ageValue) || parseFloat(ageValue) <= 0) {
        ageInput.classList.add("error"); // Highlight in red
        errorMessage.style.display = "block"; // Show error message
        return; // Stop execution
    } else {
        ageInput.classList.remove("error"); // Remove red highlight
        errorMessage.style.display = "none"; // Hide error message
    }
         
         let indata = {};
        let shapImpact = [];
        let patientRecommendations = []; // ✅ FIXED: Ensure empty array before updating

        // ✅ FIX: Ensure model.js is properly loaded before running `score()`
            if (typeof score !== "function") {
                console.error("⚠️ ERROR: score() function is not defined. Check that model.js is properly linked.");
                document.getElementById("resultText").innerText = "Error: Model not loaded.";
                return; // Stop execution
            }

         if (typeof score == "function") {
                console.log("🚀 Score is recognized as a function!");
            }

        // ✅ FIX: Correctly retrieve input values
            let agept = parseFloat(ageValue);
            let race = document.getElementById("Race")?.value;
            console.log(`🎯 Retrieved Race Value: ${race}`);
            let ethnicity = document.getElementById("Ethnicity")?.value;
            let language = document.getElementById("PreferredLanguage")?.value;
            let insurance = document.getElementById("Insurance")?.value;
            let employment = document.getElementById("Employment")?.value;
            let income = parseFloat(document.getElementById("IncomeZip")?.value);
            let distance = parseFloat(document.getElementById("DistanceHospital")?.value);
            let kps = document.getElementById("KPSPostOp")?.value;

            // ✅ FIX: Debugging checks
            console.log("🚀 Input values:", { agept, race, ethnicity, language, insurance, employment, income, distance, kps });

            // 1️⃣ Minority Patients
            if (["Asian", "Black", "Other", "NativeAmerican", "Pacific"].includes(race) || ethnicity === "1") {
                patientRecommendations.push({
                    message: "Historically, minority patients have been underrepresented in clinical trials, limiting the generalizability of scientific findings.<sup>4-6</sup>",
                    recommendations: [
                        "Address underlying socioeconomic, healthcare access, and cultural barriers.<sup>2-3</sup>",
                        "Re-evaluate non-essential inclusion/exclusion criteria that may disproportionately exclude minority patients.<sup>3,7</sup>",
                        "Work to build trust with patients of all backgrounds over time, as a patient's trust in their physician is key to facilitating enrollment.<sup>2</sup>"
                    ]
                });
            }

            // 2️⃣ Non-English Language
            if (language === "2") {
                patientRecommendations.push({
                    message: "Patients with limited or moderate English proficiency are underrepresented in clinical trials.<sup>8</sup>",
                    recommendations: [
                        "It is crucial to translate all study materials and use medical interpreters or certified bilingual providers for all clinical trial screening discussions, which focus on nuanced treatments and challenging decisions.<sup>8</sup>"
                    ]
                });
            }

            // 3️⃣ Financial Barriers
            if (["2", "3", "5"].includes(insurance) || employment === "2" || income < 54000) {
                patientRecommendations.push({
                    message: "Under/uninsured, lower-income, and unemployed patients may not enroll due to hidden costs of enrollment (e.g., travel costs, lost wages, out-of-pocket costs).<sup>2</sup>",
                    recommendations: [
                        "Collaborate with social work colleagues to ease financial burdens.",
                        "Advocate for sponsors of clinical trials to establish financial reimbursement programs to anticipate and help cover unexpected costs of participation.<sup>2,9</sup>",
                        "Create targeted funding mechanisms for clinical trials that focus exclusively on cancer health disparities.<sup>2-3</sup>"
                    ]
                });
            }

            // 4️⃣ Distance from Hospital
            if (distance >= 30) {
                patientRecommendations.push({
                    message: "Patients living farther from the hospital, such as rural patients, may struggle to enroll due to transportation time and costs.<sup>10-11</sup>",
                    recommendations: [
                        "Offer remote/home-based visits, consolidated appointments, travel vouchers, and temporary local housing options whenever possible.<sup>6,9-10</sup>"
                    ]
                });
            }

            // 5️⃣ Functional Status (KPS Score)
            if (kps === "<80") {
                patientRecommendations.push({
                    message: "Patients with lower functional status may face eligibility challenges.<sup>12-13</sup>",
                    recommendations: [
                        "Evaluate functional status periodically to reassess trial eligibility."
                    ]
                });
            }

            // 7️⃣ Older Patients
            if (agept > 65) {
                patientRecommendations.push({
                    message: "A large percentage of clinical trials have age-based exclusion criteria.<sup>14-15</sup>",
                    recommendations: [
                        "Discuss goals of care with all patients regardless of age.",
                        "Advocate for functional status-based and goals of care-based eligibility criteria, rather than strict age-based cutoffs.<sup>16</sup>"
                    ]
                });
            }
        
        // Correct categorical mappings
        const categoricalMappings = {
            "WHOGrade": { "2-3": 0, "4": 1 }, // WHO Grade mapping
            "Race": { "White": 6, "Black": 2, "NativeAmerican": 0, "Asian": 1, "Pacific": 3, "Other": 4, "Unknown": 5 }, // Race mapping
            "Chemotherapy": { "1": 2, "2": 0, "Unknown": 1 }, // TMZ Chemotherapy mapping
            "Seizure": { "Yes": 2, "No": 1, "NA": 0 }, // Seizure mapping
            "Insurance": { "1": 0, "2": 1, "3": 2, "4": 3, "5": 4 }, // Insurance mapping
            "TumorLobe": { "Brainstem": 0, "Cerebellum": 1, "Frontal": 2, "Multifocal": 3, "Occipital": 4, "Parietal": 5, "Temporal": 6, "Unknown": 7 }, // Tumor Lobe mapping
            "KPSPostOp": { "100": 3, "90": 2, "80": 1, "<80": 0, "NA": 4 }, // KPS Post-op mapping
            "Ethnicity": { "1": 0, "2": 1, "Unknown": 2 }, // Ethnicity mapping
            "Employment": { "1": 0, "2": 1, "3": 2, "Unknown": 3 }, // Employment mapping
            "Sex": { "1": 1, "2": 2 } // Sex mapping
        };

        // Map input values to the correct model variable names
        const variableMap = {
            "AgeDiagnosis": "Age.at.Initial.Diagnosis",
            "Employment": "Employed(Y=1, N=2, Retired=3) 2",
            "Ethnicity": "Ethnicity Hispanic/Latino (Yes=1, No=2) 2",
            "KPSPostOp": "KPS.post.op 3",
            "TumorLobe": "New Tumor Lobe (updated chart review) 2 2 2",
            "Insurance": "Reordered insurance at diagnosis 2 2",
            "Seizure": "Seizure.preop 2",
            "Sex": "Sex (M=1, F=2)",
            "Chemotherapy": "TMZ anytime 2 2",
            "Race": "Updated Race White, Black/African American, Hispanic/Latino, Asian/Pacific Islander, American Indian/Alaska Native 3 2",
            "WHOGrade": "WHO Grade 2 2"
        };

        for (let shortName in variableMap) {
            let fullName = variableMap[shortName];
            let inputElement = document.getElementById(shortName);
            if (inputElement) {
                let value = inputElement.value.trim();

                // Convert categorical variables before sending them to model.js
                if (categoricalMappings[shortName]) {
                    indata[fullName] = categoricalMappings[shortName][value] ?? -1;
                } else {
                    indata[fullName] = isNaN(value) || value === "" ? value : parseFloat(value);
                }
            }
        }

        console.log("🚀 Input Data Sent to Model first time:", JSON.stringify(indata, null, 2));

        if (typeof score === "function") {
            let outdata = {};
         console.log("🚀 Input Data Sent to Model right before score:", JSON.stringify(indata, null, 2));
         Object.keys(indata).forEach(key => {
          if (indata[key] === undefined || indata[key] === "") {
           console.warn(`⚠️ Missing input for: ${key}`);
          }
});
            score(indata, outdata);
            console.log("📊 Output Data from Model:", outdata);

            // Retrieve probability values
            let probabilityYes = outdata["ProbabilityEnroll"];
            let probabilityNo = outdata["ProbabilityNotEnroll"];

            if (!isNaN(probabilityYes) && probabilityYes !== undefined) {
                document.getElementById("resultText").innerText = `${(probabilityYes*100).toFixed(2)}%`;
                document.getElementById("resultBox").style.display = "block";
            } else {
                document.getElementById("resultText").innerText =
                    "Error: Probability could not be calculated.";
                console.error("⚠️ Probability is NaN or undefined. Check input processing.");
            }
        } else {
            console.error("⚠️ score function is not defined. Make sure model.js is properly loaded.");
        }

        
        let ages = parseFloat(ageValue);
            function getAgeCategory(ages) {
    if (ages < 20) return "Being less than 20 years old at diagnosis";
    if (ages < 30) return "Being 20-29 years old at diagnosis";
    if (ages < 40) return "Being 30-39 years old at diagnosis";
    if (ages < 50) return "Being 40-49 years old at diagnosis";
    if (ages < 60) return "Being 50-59 years old at diagnosis";
    if (ages < 70) return "Being 60-69 years old at diagnosis";
    if (ages < 80) return "Being 70-79 years old at diagnosis";
    return "Being 80 years old or older at diagnosis";
}
        if (!isNaN(ages)) {
    let ageCategory = getAgeCategory(ages);
    let ageImpact = shapValues["AgeDiagnosis"](ages);  // Get SHAP impact value

    shapImpact.push({
        feature: ageCategory,  // ✅ Now uses readable age label
        impact: ageImpact
    });
}
        // Define readable labels for easier interpretation
        const readableLabels = {
            "Ethnicity": { "1": "Hispanic/Latino", "2": "Non-Hispanic/Latino", "Unknown": "Unknown" },
            "Sex": { "1": "Male", "2": "Female" },
            "Insurance": { "1": "Private", "2": "Medi-cal/Medicaid", "3": "Medicare", "4": "Unknown", "5": "Self-pay" },
            "Employment": { "1": "Employed", "2": "Unemployed", "3": "Retired", "Unknown": "Unknown" },
            "WHOGrade": { "2-3": "Grade 2-3", "4": "Grade 4" },
            "TumorLobe": { 
                "Frontal": "Frontal", "Parietal": "Parietal", "Temporal": "Temporal", 
                "Brainstem": "Brainstem, Insular, Basal Ganglia, or Thalamus",
                "Multifocal": "Multifocal", "Occipital": "Occipital",
                "Cerebellum": "Cerebellum", "Unknown": "Unknown"
            },
            "Seizure": { "Yes": "Yes", "No": "No", "NA": "Unknown" },
            "KPSPostOp": { "100": "100", "90": "90", "80": "80", "<80": "Less than 80", "NA": "Unknown" },
            "Chemotherapy": { "1": "Yes", "2": "No", "Unknown": "Unknown" }
        };   

        const formattedLabels = {
            "Race": {
                "Pacific": "Native Hawaiian/Pacific Islander",
                "NativeAmerican": "American Indian/Alaska Native",
                "Black": "Black/African American"
            },
            "TumorLobe": {
                "Brainstem": "Brainstem/Insular/Basal Ganglia/Thalamus"
            }
        };
        
        document.querySelectorAll("select, input").forEach(el => {
                let category = el.id;
                let value = el.value;
                indata[category] = value;
           
         let displayValue = readableLabels[category] && readableLabels[category][value]
                 ? readableLabels[category][value]  // ✅ Convert to readable label if available
                 : value;

        // ✅ Apply formatting if a readable display label exists
        if (formattedLabels[category] && formattedLabels[category][value]) {
            displayValue = formattedLabels[category][value];
        }
           
        let impactValue = shapValues[category] && shapValues[category][value] !== undefined
            ? shapValues[category][value]
            : "N/A";
           
        console.log(`📝 Processing ${category}: User Input = ${displayValue}, Coded Impact = ${impactValue}`);
           
                if (shapValues[category] && shapValues[category][value] !== undefined) {
                    shapImpact.push({
                       feature: formatImpactFeature(category, value), // ✅ Converts into readable text
                        impact: shapValues[category][value]
                    });
                }
            console.log("📊 Full List of Computed SHAP Impact Factors:", shapImpact);
        }); // ✅ Correct

        shapImpact.sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));
        console.log("📊 Full Sorted SHAP Impact Factors:", shapImpact);

        let positiveImpact = shapImpact
            .filter(d => d.impact > 0)
            .slice(0, 2);
        console.log("🔻 Sorted Positive Impact Factors:", positiveImpact);

        // Fix: Sort negative impacts in descending order to show the most negative first
        let negativeImpact = shapImpact
            .filter(d => d.impact < 0)
            .sort((a, b) => a.impact - b.impact) // Corrected sorting
            .slice(0, 2);

            console.log("✅ Final Sorted Positive Impact Factors:", positiveImpact);
            console.log("❌ Final Sorted Negative Impact Factors:", negativeImpact);
           
            updateImpactDisplay(positiveImpact, negativeImpact);
            updateRecommendationDisplay(patientRecommendations);
           
        }

     // Mapping function to convert variable-value pairs into readable text
function formatImpactFeature(variable, value) {
    const mappings = {
        "KPSPostOp": {
            "100": "Post-operative KPS of 100",
            "90": "Post-operative KPS of 90",
            "80": "Post-operative KPS of 80",
            "<80": "Post-operative KPS of less than 80"
        },
     "TumorLobe": {
            "Frontal": "Frontal lobe tumor", 
            "Parietal": "Parietal lobe tumor",
            "Temporal": "Temporal lobe tumor", 
             "Brainstem": "Tumor located in the brainstem, insula, basal ganglia, or thalamus",
                "Multifocal": "Multifocal tumor location", 
      "Occipital": "Occipital lobe tumor",
                "Cerebellum": "Cerebellar tumor"
        },
        "Race": {
            "White": "White race",
            "Black": "Black/African American race",
            "Asian": "Asian race",
            "NativeAmerican": "American Indian/Alaska Native race",
            "Pacific": "Native Hawaiian/Pacific Islander race"
        },
        "Ethnicity": {
            "1": "Hispanic/Latino ethnicity",
            "2": "Non-Hispanic/Latino ethnicity"
        },
        "Sex": {
            "1": "Male sex",
            "2": "Female sex"
        },
        "WHOGrade": {
            "4": "WHO Grade 4 tumor",
            "2-3": "WHO Grade 2-3 tumor"
        },
        "Chemotherapy": {
            "1": "History of chemotherapy treatment",
            "2": "No history of chemotherapy treatment"
        },
        "Insurance": {
            "1": "Private insurance",
            "2": "Medicaid/Medi-cal insurance",
            "3": "Medicare insurance",
            "5": "No insurance/self-pay"
        },
        "Employment": {
            "1": "Being employed",
            "2": "Being unemployed",
            "3": "Being retired"
        },
        "Seizure": {
            "Yes": "Seizures at diagnosis",
            "No": "No seizures at diagnosis"
        }
    };

    // Return formatted string or fallback to the original value
    return mappings[variable]?.[value] || `${variable}=${value}`;
}

     
        function updateImpactDisplay(positiveImpact, negativeImpact) {
    let positiveImpactTableBody = document.getElementById("positiveImpactTableBody");
    let negativeImpactTableBody = document.getElementById("negativeImpactTableBody");

    // Clear table contents before updating
    positiveImpactTableBody.innerHTML = "";
    negativeImpactTableBody.innerHTML = "";

    // Insert positive impact factors
    if (positiveImpact.length > 0) {
        positiveImpact.forEach(item => {
            let row = document.createElement("tr");
            let cell = document.createElement("td");

            // 🛠 FIX: Ensure `formatImpactFeature` handles single-word features without adding "="
            let featureParts = item.feature.split("=");
            let formattedFeature = formatImpactFeature(featureParts[0], featureParts[1] ? featureParts[1] : "").replace(/=$/, '');

            cell.innerHTML = `• <strong>${formattedFeature}</strong>: average increase of <strong>${(item.impact * 100).toFixed(2)}%</strong> in estimated enrollment probability`;
            row.appendChild(cell);
            positiveImpactTableBody.appendChild(row);
        });
    } else {
        let row = document.createElement("tr");
        let cell = document.createElement("td");
        cell.innerText = "No strong positive factors";
        row.appendChild(cell);
        positiveImpactTableBody.appendChild(row);
    }

    // Insert negative impact factors
    if (negativeImpact.length > 0) {
        negativeImpact.forEach(item => {
            let row = document.createElement("tr");
            let cell = document.createElement("td");

            // 🛠 FIX: Ensure `formatImpactFeature` handles single-word features without adding "="
            let featureParts = item.feature.split("=");
            let formattedFeature = formatImpactFeature(featureParts[0], featureParts[1] ? featureParts[1] : "").replace(/=$/, '');

            cell.innerHTML = `• <span style="color: #C04C00;"><strong>${formattedFeature}</strong></span>: average decrease of <span style="color: #C04C00; font-weight: bold;">${Math.abs(item.impact * 100).toFixed(2)}%</span> in estimated enrollment probability`;
            row.appendChild(cell);
            negativeImpactTableBody.appendChild(row);
        });
    } else {
        let row = document.createElement("tr");
        let cell = document.createElement("td");
        cell.innerText = "No strong negative factors";
        row.appendChild(cell);
        negativeImpactTableBody.appendChild(row);
    }
}

        function updateRecommendationDisplay(patientRecommendations) {
                let recommendationTableBody = document.getElementById("patientRecommendationTableBody");
                recommendationTableBody.innerHTML = ""; // Clear existing content

                patientRecommendations.forEach(item => {
                    let row = document.createElement("tr");
                    let characteristicCell = document.createElement("td");
                    let recommendationsCell = document.createElement("td");

                    characteristicCell.innerHTML = `<span class="characteristics"><strong>${item.message}</strong></span>`;

                    let recommendationList = "<ul>";
                    item.recommendations.forEach(rec => {
                        recommendationList += `<li>${rec}</li>`;
                    });
                    recommendationList += "</ul>";

                    recommendationsCell.innerHTML = `<span class="recommendations">${recommendationList}</span>`;

                    row.appendChild(characteristicCell);
                    row.appendChild(recommendationsCell);
                    recommendationTableBody.appendChild(row);
                });
            }


        function updateGeneralRecommendations() {
            let generalRecommendationTableBody = document.getElementById("generalRecommendationTableBody");
            generalRecommendationTableBody.innerHTML = ""; // Clear existing content

            const generalRecommendations = [
                {
                    pattern: "In a recent study of adult glioma patients, only 43-49% were screened for a clinical trial.<sup>1</sup>",
                    recommendation: "Adopt a 'just ask' policy for clinical trial discussions, asking all patients who might be eligible about their enrollment interest.<sup>2-3</sup>"
                },
                {
                    pattern: "In a recent study, the odds of trial enrollment increased in a dose-dependent fashion with the numbers of trials discussed during screening.",
                    recommendation: [
                        "Find multiple opportunities to discuss clinical trial enrollment with patients.",
                        "Discuss all available trials with patients to maximize enrollment opportunities.",
                        "Patients are often most motivated to participate by the prospect of helping future patients like them."
                    ]
                    
                },
                {
                    pattern: "Individual patients face unique challenges to and motivations for trial enrollment.<sup>2-3</sup>",
                    recommendation: "Use a patient-centered and multidisciplinary approach to understand and address enrollment barriers.<sup>2-3</sup>"
                }
            ];

            generalRecommendations.forEach(item => {
                let row = document.createElement("tr");
                let patternCell = document.createElement("td");
                let recommendationCell = document.createElement("td"); // ✅ Fixed: Define recommendationCell before using it

                // ✅ Ensure the Screening Discussion Patterns appear in the left column
                patternCell.innerHTML = `<span class="characteristics"><strong>${item.pattern}</strong></span>`;

                // Check if the recommendation is an array (multiple bullet points)
                if (Array.isArray(item.recommendation)) {
                    let recommendationList = "<ul>";  // Start the unordered list
                    item.recommendation.forEach(rec => {
                        recommendationList += `<li>${rec}</li>`; // Add each recommendation as a list item
                    });
                    recommendationList += "</ul>"; // Close the unordered list
                    recommendationCell.innerHTML = `<span class="recommendations">${recommendationList}</span>`;
                } else {
                    // If it's a single string, display it normally
                    recommendationCell.innerHTML = `<span class="recommendations">${item.recommendation}</span>`;
                }
                
                row.appendChild(patternCell);
                row.appendChild(recommendationCell);
                generalRecommendationTableBody.appendChild(row);
            });
        }

        window.onload = function() {
            updateGeneralRecommendations();
        };

        
    </script>

</body>
</html>
